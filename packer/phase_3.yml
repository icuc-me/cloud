---

# FIXME: this needs to run using phase_2 fedora image in GCE

variables:
    GCE_SSH_USERNAME:
    GCP_PROJECT_ID:
    GCP_ZONE:
    VPC_NET:
    IMAGE_PROJECT_ID:
    BUILT_IMAGE_SUFFIX:
    CI_IMAGE_NAME:
    SRC_DIR:
    ADMIN_USERNAME:
    ADMIN_PASSWORD:
    UUID: '{{uuid}}'
    TIMESTAMP: '{{timestamp}}'

sensitive-variables:
    - 'GCE_SSH_USERNAME'
    - 'GCP_PROJECT_ID'
    - 'GCP_ZONE'
    - 'VPC_NET'
    - 'ADMIN_USERNAME'
    - 'ADMIN_PASSWORD'

builders:
    - type: 'googlecompute'
      name: '{{user `CI_IMAGE_NAME`}}'
      project_id: '{{user `IMAGE_PROJECT_ID`}}'
      communicator: 'ssh'
      ssh_username: '{{user `GCE_SSH_USERNAME`}}'
      ssh_pty: 'true'
      zone: '{{user `GCP_ZONE`}}'
      image_name: '{{user `CI_IMAGE_NAME`}}-{{user `BUILT_IMAGE_SUFFIX`}}'
      image_family: '{{user `CI_IMAGE_NAME`}}'
      source_image_family: 'centos-7'
      source_image_project_id: 'centos-cloud'
      network: '{{user `VPC_NET`}}'
      network_project_id: '{{user `GCP_PROJECT_ID`}}'
      scopes:
        - "https://www.googleapis.com/auth/userinfo.email"
        - "https://www.googleapis.com/auth/compute"
        - "https://www.googleapis.com/auth/devstorage.full_control"
      labels:
          uuid: '{{user `UUID`}}'
          last_used: '{{user `TIMESTAMP`}}'

provisioners:
    - type: 'file'
      source: '{{user `SRC_DIR`}}'
      destination: '/tmp/{{user `UUID`}}'

    - type: 'shell'
      script: '{{user `SRC_DIR`}}/packer/{{build_name}}_setup.sh'
      environment_vars:
          - 'UUID={{user `UUID`}}'
          - 'SRC_DIR=/tmp/{{user `UUID`}}'

    # Give deferred cleanup in setup script time to complete
    - type: 'shell-local'
      command: 'sleep 1m'

post-processors:
    - - type: 'manifest'
        strip_path: true
        custom_data:
            uuid: '{{user `UUID`}}'
            last_used: '{{user `TIMESTAMP`}}'
